<%- include('partials/header') %>

<main class="container py-5">
  <div class="text-center text-white mb-5">
    <h1 class="fw-bold">Tukar Poin</h1>
    <p class="text-white-50">Konversi Poin Anda menjadi Tiket Raffle untuk kesempatan memenangkan hadiah.</p>
  </div>

  <div class="row g-4 justify-content-center">
    <div class="col-lg-5">
      <div class="card bg-dark text-white h-100 shadow-p3 rounded-3 border-0">
        <div class="card-body p-4">
          <h5 class="card-title text-light fw-bold mb-4">Konversi Poin ke Tiket</h5>
          
          <form action="/tukar-point" method="POST" id="form-penukaran" onsubmit="return konfirmasiTukar(event)">
            <div class="mb-3">
              <label for="jumlah" class="form-label text-white-50">Anda Tukar (Poin)</label>
              <div class="input-group">
                <input 
                  type="number" 
                  name="jumlah" 
                  id="jumlah"
                  class="form-control form-control-lg bg-dark text-white border-light border border-2" 
                  placeholder="Kelipatan 100" 
                  min="100" 
                  step="100" 
                  required
                  oninput="updateEstimasi()">
                <span class="input-group-text bg-dark text-light border-light border border-2">POIN</span>
              </div>
              <div class="form-text text-white-50 mt-2">Saldo Anda: <span id="user-points-balance"><%= user.points.toLocaleString('id-ID') %></span> Poin</div>
            </div>

            <div class="text-center my-3">
              <i class="bi bi-arrow-down-up fs-4 text-secondary"></i>
            </div>
            
            <div class="mb-4">
              <label class="form-label text-white-50">Anda Dapat (Tiket)</label>
              <div class="input-group">
                  <input type="text" id="estimasi" class="form-control form-control-lg bg-secondary border-secondary text-white fw-bold" value="0" readonly>
                  <span class="input-group-text bg-secondary text-white border-secondary">TIKET</span>
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold">
              <i class="bi bi-ticket-perforated me-2"></i> Konfirmasi Penukaran
            </button>
          </form>
        </div>
      </div>
    </div>

    </div>
</main>

<script>
// Fungsi Estimasi (Diperbaiki dengan Null Check)
function updateEstimasi() {
    // TAMBAHKAN NULL CHECK DI SINI
    const poinInput = document.getElementById('jumlah');
    const estimasiOutput = document.getElementById('estimasi');
    
    // KODE PERBAIKAN: Jika elemen tidak ditemukan (null), segera keluar dari fungsi
    if (!poinInput || !estimasiOutput) {
        return 0;
    }

    // Ambil saldo user secara aman
    const saldoUser = Number('<%= user.points %>'); 
    
    const poin = parseInt(poinInput.value) || 0;
    const rasioTiket = 100; // 1 Tiket = 100 Poin

    if (poin >= rasioTiket && poin % 100 === 0 && poin <= saldoUser) {
        const tiket = poin / rasioTiket;
        estimasiOutput.value = tiket;
        return tiket;
    } else {
        estimasiOutput.value = 0;
        return 0;
    }
}

// Fungsi Konfirmasi Utama (Dipanggil saat form disubmit)
function konfirmasiTukar(event) {
    const jumlahPoin = parseInt(document.getElementById('jumlah').value);
    const jumlahTiket = updateEstimasi(); 
    const saldoUser = Number('<%= user.points %>'); 

    // 1. Validasi Kritis
    if (jumlahTiket <= 0) {
        alert("Kesalahan: Masukkan jumlah Poin yang valid (kelipatan 100).");
        event.preventDefault(); 
        return false;
    }
    
    if (jumlahPoin > saldoUser) {
        alert("Kesalahan: Saldo Poin Anda tidak mencukupi untuk penukaran ini.");
        event.preventDefault(); 
        return false;
    }

    // 2. Tampilkan Pop-up Konfirmasi (Yes/No)
    const konfirmasi = confirm(
        `PERINGATAN! Anda akan menukarkan ${jumlahPoin.toLocaleString('id-ID')} Poin untuk mendapatkan ${jumlahTiket} Tiket Raffle.\n\nApakah Anda yakin ingin melanjutkan penukaran?`
    );

    // 3. Kontrol Submit
    if (konfirmasi) {
        return true; 
    } else {
        event.preventDefault(); 
        return false;
    }
}

// Panggil updateEstimasi saat halaman dimuat
document.addEventListener('DOMContentLoaded', updateEstimasi);
</script>

<%- include('partials/footer') %>
