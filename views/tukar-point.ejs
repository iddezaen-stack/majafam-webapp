<%- include('partials/header') %>
<script>
// Fungsi Estimasi (Diperlukan untuk Logika Konfirmasi)
function updateEstimasi() {
    const poinInput = document.getElementById('jumlah');
    const estimasiOutput = document.getElementById('estimasi');
    
    // PERBAIKAN 1: Ambil saldo user dari elemen HTML yang sudah disisipkan EJS
    // Kita ambil dari elemen span yang menampilkan saldo (misalnya "user-points")
    // Karena kita tidak mendefinisikan span tersebut, kita langsung sisipkan nilai EJS di sini:
    const saldoUser = Number('<%= user.points %>'); 
    
    const poin = parseInt(poinInput.value) || 0;
    const rasioTiket = 100; // 1 Tiket = 100 Poin

    if (poin >= rasioTiket && poin % rasioTiket === 0 && poin <= saldoUser) {
        const tiket = poin / rasioTiket;
        estimasiOutput.value = tiket;
        return tiket;
    } else {
        estimasiOutput.value = 0;
        return 0;
    }
}

// Fungsi Konfirmasi Utama (Dipanggil saat form disubmit)
function konfirmasiTukar(event) {
    const jumlahPoin = parseInt(document.getElementById('jumlah').value);
    const jumlahTiket = updateEstimasi(); 
    const saldoUser = Number('<%= user.points %>'); // Ambil saldo lagi untuk validasi

    // 1. Validasi Kritis
    if (jumlahTiket <= 0) {
        alert("Kesalahan: Masukkan jumlah Poin yang valid (kelipatan 100).");
        event.preventDefault(); 
        return false;
    }
    
    if (jumlahPoin > saldoUser) {
        alert("Kesalahan: Saldo Poin Anda tidak mencukupi untuk penukaran ini.");
        event.preventDefault(); 
        return false;
    }

    // 2. Tampilkan Pop-up Konfirmasi (Yes/No)
    const konfirmasi = confirm(
        `PERINGATAN! Anda akan menukarkan ${jumlahPoin.toLocaleString('id-ID')} Poin untuk mendapatkan ${jumlahTiket} Tiket Raffle.\n\nApakah Anda yakin ingin melanjutkan penukaran?`
    );

    // 3. Kontrol Submit
    if (konfirmasi) {
        return true; 
    } else {
        event.preventDefault(); 
        return false;
    }
}

// Panggil updateEstimasi saat halaman dimuat
document.addEventListener('DOMContentLoaded', updateEstimasi);
</script>

<%- include('partials/footer') %>