<%- include('partials/header') %>

<main class="container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-white">Riwayat Aktivitas</h2>
        <span class="badge bg-primary fs-6">Saldo Poin: <%= user.points %></span> 
    </div>

    <% if (history.length > 0) { %>
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle rounded-3 overflow-hidden">
                <thead>
                    <tr class="bg-secondary text-white">
                        <th scope="col">Tanggal</th>
                        <th scope="col">Jenis Aktivitas</th> <th scope="col" class="text-center">Poin</th>
                        <th scope="col">Deskripsi</th> </tr>
                </thead>
                <tbody>
                    <% history.forEach(h => { 
                        // Perbaikan: Variabel poin sekarang adalah 'change_amount'
                        const points = parseInt(h.change_amount);
                        const isPositive = points > 0;
                        const statusClass = isPositive ? 'text-success' : 'text-danger';
                        const sign = isPositive ? '+' : '';

                        let activityBadge = 'Lainnya';
                        let badgeColor = 'bg-secondary';

                        // Logika Penentuan Jenis Aktivitas (Berdasarkan h.type dari UNION ALL)
                        if (h.type === 'TASK_APPROVED') {
                            activityBadge = 'Tugas Disetujui';
                            badgeColor = 'bg-success';
                        } else if (h.type === 'TASK_REJECTED') {
                            activityBadge = 'Tugas Ditolak';
                            badgeColor = 'bg-danger';
                        } else if (points > 0) {
                            activityBadge = 'Poin Masuk';
                            badgeColor = 'bg-info';
                        } else if (points < 0) {
                            activityBadge = 'Poin Keluar (Tukar)';
                            badgeColor = 'bg-warning text-dark';
                        }
                    %>
                        <tr>
                            <td><%= new Date(h.created_at).toLocaleString("id-ID") %></td>
                            
                            <td><span class="badge <%= badgeColor %>"><%= activityBadge %></span></td>
                            
                            <td class="text-center fw-bold <%= statusClass %>">
                                <%= sign %><%= points %>
                            </td>
                            <td><%= h.description %></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    <% } else { %>
        <p class="text-muted text-center p-5">Belum ada riwayat aktivitas yang tercatat.</p>
    <% } %>

</main>

<%- include('partials/footer') %>
